<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>मस्जिद-ए-अमन - होम</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            color-scheme: light; 
            --primary-green: #166534;
            --secondary-gold: #ca8a04;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0fdf4;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%23a7f3d0' fill-opacity='0.4'%3E%3Cpath opacity='.5' d='M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4Z'/%3E%3Cpath d='M6 5V0h1v5h5v1H6v5H5V6H0V5h5Z'/%3E%3C/g%E3%E3C/g%E3E%3C/svg%E3E");
            animation: bg-pan-y 80s linear infinite;
        }
        @keyframes bg-pan-y {
          0% { background-position: 50% 0%; }
          100% { background-position: 50% 100%; }
        }
        .urdu-title { font-family: 'Noto Nastaliq Urdu', serif; }
        .card { transition: all 0.3s ease-in-out; }
        .card:hover { transform: translateY(-8px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); }
        .fade-in { animation: fadeIn 1s ease-out forwards; opacity: 0; }
        .admin-controls { display: none; }
        .group:hover .admin-controls-hover { display: flex; }
        .admin-controls-top { position: absolute; top: 0.5rem; right: 0.5rem; }
        .header-border {
            border-bottom: 3px solid transparent;
            border-image: linear-gradient(to right, #22c55e, #ca8a04) 1;
        }
        .tab-btn { border-bottom: 3px solid transparent; }
        .tab-btn.active { border-bottom-color: #166534; color: #166534; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #qibla-compass { width: 150px; height: 150px; background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/8/88/Simple_Compass_Rose.svg/1024px-Simple_Compass_Rose.svg.png') no-repeat center center; background-size: contain; position: relative; margin: 20px auto; }
        #qibla-arrow { width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 70px solid #dc2626; position: absolute; top: 5px; left: 50%; transform-origin: 50% 100%; transition: transform 0.5s ease; margin-left: -10px;}

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .editable-time {
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .editable-time:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="app" class="min-h-screen w-full flex flex-col items-center p-4">
        <!-- Header -->
        <header class="sticky top-0 left-0 right-0 p-4 bg-white/90 backdrop-blur-sm shadow-md z-20 flex justify-between items-center header-border flex-wrap">
            <!-- Left Side: Title -->
            <div class="flex items-center gap-3">
                <svg class="w-10 h-10 text-green-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" fill="currentColor"><path d="M542.2 24.1c-3-2.1-6.6-2.9-10.2-2.3C523.3 23.4 512 32.8 512 44.1v8.3c0 2.4-1.3 4.6-3.4 5.8L280.4 195.8l-3.3 1.7-3.3-1.7L45.4 58.2C43.3 57 42 54.8 42 52.4v-8.3C42 32.8 30.7 23.4 22 21.8c-3.6-.6-7.2.2-10.2 2.3C7.9 26.9 0 35.1 0 44.1v396.2c0 14.5 11.4 26.7 25.8 27.8c1.3.1 2.6.2 3.9.2c2.4 0 4.8-.4 7.1-1.1c8.5-2.8 13.2-12.1 10.3-20.6C44.2 438 48 432.5 48 426.7V256.9l22.6 11.9L288 377.9l217.4-109.1L528 256.9V426.7c0 5.8 3.8 11.3 6.9 14.1c2.9 8.5-1.9 17.8-10.3 20.6c-2.3.8-4.7 1.1-7.1 1.1c-1.3 0-2.6-.1-3.9-.2C564.6 466.9 576 454.8 576 440.3V44.1c0-9.1-7.9-17.2-11.8-20zM288 334L96 226.7V426.7c0 5.8 3.8 11.3 6.9 14.1c2.9 8.5-1.9 17.8-10.3 20.6C89.1 462.2 86 464 82.1 464c-1.3 0-2.6-.1-3.9-.2C63.4 462.6 48 447.1 48 426.7V101.4l240 126.3zm232-15.3l-240-126.3v325.3c0 20.4-15.4 35.9-31.8 37.1c-1.3.1-2.6.2-3.9.2c-3.9 0-7.1-1.8-10.3-4.5c2.9-8.5-1.9-17.8-10.3-20.6c-3.1-2.8-6.9-8.3-6.9-14.1V226.7L288 334z"/></svg>
                <h1 class="urdu-title text-2xl sm:text-3xl font-bold text-green-900">मस्जिद-ए-अमन</h1>
            </div>

            <!-- Right Side: All Actions -->
            <div class="flex items-center gap-2 sm:gap-4 flex-wrap justify-end">
                <a href="monthly-chanda.html" class="text-green-800 font-semibold py-2 px-3 rounded-lg hover:bg-green-100 transition-all duration-300 text-xs sm:text-sm">मासिक चंदा</a>
                <a href="anya-chanda.html" class="text-green-800 font-semibold py-2 px-3 rounded-lg hover:bg-green-100 transition-all duration-300 text-xs sm:text-sm">आमदनी-खर्च</a>
                <div id="visitor-actions" class="flex gap-2">
                    <button id="show-login-modal-btn" class="bg-white text-green-800 font-semibold py-2 px-3 rounded-lg hover:bg-green-50 transition-all duration-300 flex items-center justify-center gap-2 shadow-sm border border-green-200 text-xs sm:text-sm">लॉगिन</button>
                    <button id="show-signup-modal-btn" class="bg-green-700 text-white font-semibold py-2 px-3 rounded-lg hover:bg-green-800 transition-all duration-300 flex items-center justify-center gap-2 shadow-md shadow-green-500/20 text-xs sm:text-sm">नया अकाउंट</button>
                </div>
                <div id="admin-area" class="hidden items-center gap-2">
                    <button id="logout-btn" class="bg-red-600 text-white font-semibold py-2 px-3 rounded-md hover:bg-red-700 transition-all duration-300 flex items-center justify-center gap-2 shadow-md shadow-red-500/20 text-sm">
                        <span>लॉगआउट</span>
                    </button>
                </div>
            </div>
        </header>

        <main class="text-center w-full max-w-5xl mx-auto pt-16">
            <h2 class="urdu-title text-5xl md:text-7xl font-bold text-green-900 drop-shadow-md fade-in">मस्जिद-ए-अमन में आपका स्वागत है</h2>
            <p class="mt-4 text-lg text-slate-600 max-w-3xl mx-auto fade-in">यह हमारी मस्जिद का official portal है। यहाँ आपको नमाज़ के समय, ज़रूरी एलान और हिसाब-किताब की पूरी जानकारी मिलेगी।</p>
            
            <!-- Info Tabs Section -->
            <section class="mt-16 fade-in">
                <div class="bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg border border-slate-200">
                    <div class="flex items-center border-b-2 border-slate-200" id="info-tabs-nav">
                        <!-- Tab buttons will be loaded here -->
                    </div>
                    <div class="pt-4" id="info-tabs-content">
                        <!-- Tab content will be loaded here -->
                    </div>
                    <div class="admin-controls mt-4 text-left">
                        <button id="add-tab-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-all duration-300 text-sm">नया टैब जोड़ें</button>
                    </div>
                </div>
            </section>

            <!-- Prayer Times Section -->
            <section class="mt-16 fade-in">
                <div class="bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="urdu-title text-3xl font-bold text-green-800">आज की नमाज़ का समय</h3>
                        <div id="prayer-time-admin-controls" class="hidden">
                             <button id="edit-prayer-times-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-all duration-300 text-sm">समय बदलें</button>
                             <div id="prayer-time-edit-buttons" class="hidden">
                                 <button id="cancel-prayer-times-btn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-all duration-300 text-sm">रद्द करें</button>
                                 <button id="save-prayer-times-btn" class="bg-green-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-800 transition-all duration-300 text-sm">सेव करें</button>
                             </div>
                         </div>
                     </div>
                    <div class="flex justify-between items-center text-slate-600 font-semibold mb-6">
                        <p id="current-date"></p>
                        <p id="hijri-date-container"></p>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4 text-white">
                        <div class="bg-green-800 p-4 rounded-lg shadow-md"> <p class="font-semibold text-lg">फज्र</p> <p class="text-2xl font-bold editable-time" id="fajr-time" contenteditable="false"></p> </div>
                        <div class="bg-yellow-600 p-4 rounded-lg shadow-md"> <p class="font-semibold text-lg">तुलु</p> <p class="text-2xl font-bold editable-time" id="tulu-time" contenteditable="false"></p> </div>
                        <div class="bg-green-700 p-4 rounded-lg shadow-md"> <p class="font-semibold text-lg">ज़ुहर</p> <p class="text-2xl font-bold editable-time" id="zuhr-time" contenteditable="false"></p> </div>
                        <div class="bg-green-600 p-4 rounded-lg shadow-md"> <p class="font-semibold text-lg">असर</p> <p class="text-2xl font-bold editable-time" id="asr-time" contenteditable="false"></p> </div>
                        <div class="bg-orange-600 p-4 rounded-lg shadow-md"> <p class="font-semibold text-lg">गुरुब</p> <p class="text-2xl font-bold editable-time" id="ghurub-time" contenteditable="false"></p> </div>
                        <div class="bg-green-800 p-4 rounded-lg shadow-md"> <p class="font-semibold text-lg">ईशा</p> <p class="text-2xl font-bold editable-time" id="isha-time" contenteditable="false"></p> </div>
                    </div>
                    <div class="mt-6 border-t pt-4 text-left">
                        <h4 class="font-bold text-green-800">आने वाले इवेंट्स:</h4>
                        <div id="events-container-small" class="mt-2 text-slate-600 text-sm space-y-1"></div>
                        <div class="admin-controls mt-2">
                             <button id="add-event-btn" class="bg-green-100 text-green-800 font-semibold py-1 px-3 rounded-lg hover:bg-green-200 transition-all duration-300 text-xs">नया इवेंट जोड़ें</button>
                        </div>
                    </div>
                </div>
            </section>
            
            <section class="mt-16 fade-in">
                <div class="bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg border border-slate-200">
                    <h3 class="urdu-title text-3xl font-bold text-green-800">Qibla Finder</h3>
                    <div id="qibla-compass">
                        <div id="qibla-arrow"></div>
                    </div>
                    <button id="find-qibla-btn" class="bg-green-700 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-800 transition-all duration-300">क़िब्ला की सिम्त मालूम करें</button>
                    <p id="qibla-message" class="text-sm text-slate-500 mt-4 h-5"></p>
                </div>
            </section>
            
            <section class="mt-16 text-left fade-in relative">
                 <h3 class="urdu-title text-4xl font-bold text-green-900 text-center">ज़रूरी एलान और प्रोग्राम</h3>
                 <div class="mt-8 bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg border border-slate-200 space-y-4" id="announcements-container"></div>
                 <div class="admin-controls mt-4 text-center">
                    <button id="add-announcement-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-all duration-300 text-sm">नया एलान जोड़ें</button>
                 </div>
            </section>
            
            <section class="mt-16 text-left fade-in relative">
                <h3 class="urdu-title text-4xl font-bold text-green-900 text-center">मस्जिद के बारे में</h3>
                <div class="mt-8 bg-white/80 backdrop-blur-sm p-8 rounded-2xl shadow-lg border border-slate-200 text-center">
                    <p id="about-us-text" class="text-slate-600 leading-relaxed"></p>
                </div>
                <div class="admin-controls admin-controls-top">
                    <button id="edit-about-us-btn" class="bg-blue-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-blue-700 transition-all duration-300 text-xs">एडिट</button>
                </div>
            </section>
            
            <section class="mt-16 text-left fade-in relative">
                 <h3 class="urdu-title text-4xl font-bold text-green-900 text-center">हमारी सेवाएं</h3>
                 <div id="services-container" class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-8"></div>
                 <div class="admin-controls mt-4 text-center">
                    <button id="add-service-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-all duration-300 text-sm">नई सेवा जोड़ें</button>
                 </div>
            </section>

            <section class="mt-16 text-left fade-in relative">
                <h3 class="urdu-title text-4xl font-bold text-green-900 text-center">तस्वीरें</h3>
                <div id="gallery-container" class="mt-8 grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                 <div class="admin-controls mt-4 text-center">
                    <button id="add-image-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-all duration-300 text-sm">नई तस्वीर जोड़ें</button>
                 </div>
            </section>

            <section class="mt-16 text-left fade-in relative">
                <h3 class="urdu-title text-4xl font-bold text-green-900 text-center">ता'अवुन (अतिया)</h3>
                <div class="mt-8 bg-white/80 backdrop-blur-sm p-8 rounded-2xl shadow-lg border border-slate-200 text-center">
                    <p class="text-slate-600 mb-8 max-w-2xl mx-auto">आपकी मदद से मस्जिद के कामों और ज़रूरतमंदों की इमदाद में आसानी होती है। आप अपना अतिया कमेटी के मेंबरान से राब्ता करके या नीचे दिए गए नंबर्स पर ऑनलाइन (Google Pay, PhonePe, etc.) भेज सकते हैं।</p>
                    <div id="contacts-container" class="grid grid-cols-1 md:grid-cols-3 gap-8"></div>
                    <div class="admin-controls mt-6 text-center">
                         <button id="add-contact-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-all duration-300 text-sm">नया संपर्क जोड़ें</button>
                    </div>
                </div>
            </section>

            <section class="mt-16 text-left fade-in">
                <h3 class="urdu-title text-4xl font-bold text-green-900 text-center">हमसे संपर्क करें</h3>
                <div class="mt-8 bg-white/80 backdrop-blur-sm p-8 rounded-2xl shadow-lg border border-slate-200 text-center">
                    <p class="text-slate-600 leading-relaxed"><span class="font-semibold">पता:</span> 123, अमन नगर, शहर का नाम, राज्य, पिन कोड</p>
                    <p class="text-slate-600 leading-relaxed mt-2"><span class="font-semibold">ईमेल:</span> contact@masjid-e-aman.com | <span class="font-semibold">फ़ोन:</span> +91 98765 43210</p>
                </div>
            </section>
        </main>
        
        <footer class="w-full max-w-5xl mx-auto mt-16 pb-8 text-center text-slate-500 text-sm border-t pt-8 border-slate-200">
            <p>&copy; <span id="current-year"></span> मस्जिद-ए-अमन. All Rights Reserved.</p>
        </footer>
    </div>

     <!-- Modals -->
    <div id="auth-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4 no-print">
        <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-sm mx-auto">
            <h3 id="auth-modal-title" class="text-xl font-bold mb-5 text-slate-800 text-center"></h3>
            <form id="auth-form">
                <div id="registration-fields">
                    <div class="mb-4">
                        <label for="auth-email" class="block text-sm font-medium text-slate-700 mb-1">ईमेल</label>
                        <input type="email" id="auth-email" class="text-sm border border-slate-300 rounded-lg w-full p-2.5 focus:outline-none focus:ring-2 focus:ring-green-600" required>
                    </div>
                    <div class="mb-5">
                        <label for="auth-password" class="block text-sm font-medium text-slate-700 mb-1">पासवर्ड (कम से कम 6 अक्षर)</label>
                        <input type="password" id="auth-password" class="text-sm border border-slate-300 rounded-lg w-full p-2.5 focus:outline-none focus:ring-2 focus:ring-green-600" required>
                    </div>
                </div>
                <div id="invite-code-field" class="hidden mb-5">
                    <label for="invite-code" class="block text-sm font-medium text-slate-700 mb-1">Secret Invite Code</label>
                    <input type="text" id="invite-code" class="text-sm border border-slate-300 rounded-lg w-full p-2.5 focus:outline-none focus:ring-2 focus:ring-green-600">
                </div>
                <p id="auth-error" class="text-red-600 text-sm text-center mb-4 h-5"></p>
                <div class="flex items-center gap-3">
                    <button type="button" id="cancel-auth-btn" class="w-full text-sm bg-slate-200 text-slate-800 font-semibold py-2.5 px-4 rounded-lg hover:bg-slate-300">रद्द करें</button>
                    <button type="submit" id="submit-auth-btn" class="w-full text-sm bg-green-700 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-green-800"></button>
                </div>
            </form>
        </div>
    </div>

    <!-- Generic Form Modal -->
    <div id="form-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4 no-print">
        <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-lg mx-auto">
            <h3 id="form-modal-title" class="text-xl font-bold mb-5 text-slate-800 text-center"></h3>
            <form id="generic-form">
                <div id="form-fields-container" class="space-y-4">
                    <!-- Dynamic fields will be inserted here -->
                </div>
                <div class="flex items-center justify-end gap-3 mt-6">
                    <button type="button" id="cancel-form-btn" class="w-full sm:w-auto text-sm bg-slate-200 text-slate-800 font-semibold py-2.5 px-4 rounded-lg hover:bg-slate-300">रद्द करें</button>
                    <button type="submit" id="save-form-btn" class="w-full sm:w-auto text-sm bg-green-700 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-green-800">सेव करें</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="image-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4 no-print">
        <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-lg mx-auto">
            <h3 id="image-modal-title" class="text-xl font-bold mb-5 text-slate-800 text-center"></h3>
            <form id="image-form">
                <input type="text" id="image-url-input" placeholder="या तस्वीर का लिंक पेस्ट करें" class="w-full text-sm border border-slate-300 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-green-600">
                <p class="text-center my-2 font-semibold text-slate-500">या</p>
                <input type="file" id="image-file-input" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                <div id="image-upload-progress" class="hidden w-full bg-gray-200 rounded-full h-2.5 mt-4">
                    <div id="progress-bar" class="bg-green-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <div class="flex items-center justify-end gap-3 mt-6">
                    <button type="button" id="cancel-image-btn" class="w-full sm:w-auto text-sm bg-slate-200 text-slate-800 font-semibold py-2.5 px-4 rounded-lg hover:bg-slate-300">रद्द करें</button>
                    <button type="submit" id="save-image-btn" class="w-full sm:w-auto text-sm bg-green-700 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-green-800">सेव करें</button>
                </div>
            </form>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDDpEUw4ATVqzhrBlMT2xRsJbfMO2hYSpc",
            authDomain: "mffund-cff0a.firebaseapp.com",
            projectId: "mffund-cff0a",
            storageBucket: "mffund-cff0a.appspot.com",
            messagingSenderId: "5155894047",
            appId: "1:5155894047:web:0956e587a14722aa23762a",  
            measurementId: "G-7S1FSEH156"
        };

        if (!firebaseConfig.apiKey) {
            document.getElementById('app').innerHTML = `<div class="p-8 text-center"><h2 class="text-2xl font-bold text-red-600">Firebase Config Missing!</h2></div>`;
        } else {
            // --- Firebase Initialization ---
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            const storage = getStorage(app);
            
            // --- UI Element Grabbing ---
            const visitorActions = document.getElementById('visitor-actions');
            const adminArea = document.getElementById('admin-area');
            const authModal = document.getElementById('auth-modal');
            const authForm = document.getElementById('auth-form');
            const prayerTimeAdminControls = document.getElementById('prayer-time-admin-controls');
            const editPrayerTimesBtn = document.getElementById('edit-prayer-times-btn');
            const prayerTimeEditButtons = document.getElementById('prayer-time-edit-buttons');
            const savePrayerTimesBtn = document.getElementById('save-prayer-times-btn');
            const cancelPrayerTimesBtn = document.getElementById('cancel-prayer-times-btn'); // This was missing
            const aboutUsTextEl = document.getElementById('about-us-text');
            const editAboutUsBtn = document.getElementById('edit-about-us-btn');
            const formModal = document.getElementById('form-modal');
            const genericForm = document.getElementById('generic-form');
            const imageModal = document.getElementById('image-modal');
            const imageForm = document.getElementById('image-form');
            const infoTabsNav = document.getElementById('info-tabs-nav');
            const infoTabsContent = document.getElementById('info-tabs-content');
            
            // --- State Variables ---
            let unsubs = [];
            let originalPrayerTimes = {};
            let originalAboutUsText = '';
            let currentEditContext = {};

            // --- Initial Page Setup ---
            document.getElementById('current-year').textContent = new Date().getFullYear();
            const dateOptions = { day: 'numeric', month: 'long', year: 'numeric', weekday: 'long' };
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('hi-IN', dateOptions);
            
            async function fetchHijriDate() {
                try {
                    const today = new Date();
                    const dateStr = `${String(today.getDate()).padStart(2, '0')}-${String(today.getMonth() + 1).padStart(2, '0')}-${today.getFullYear()}`;
                    const response = await fetch(`https://api.aladhan.com/v1/gToH?date=${dateStr}`);
                    const data = await response.json();
                    if (data.code === 200) {
                        const hijri = data.data.hijri;
                        document.getElementById('hijri-date-container').textContent = `${hijri.day} ${hijri.month.ar}, ${hijri.year} AH`;
                    }
                } catch (e) { console.error("Could not fetch Hijri date:", e); }
            }
            fetchHijriDate();

            // --- Core Logic ---
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    try { await signInAnonymously(auth); return; } 
                    catch (error) { console.error("Anonymous sign-in failed", error); return; }
                }
                const adminDocRef = doc(db, "admins", user.uid);
                const adminDocSnap = await getDoc(adminDocRef);
                setupUI(adminDocSnap.exists());
                fetchAllData();
            });

            function setupUI(isAdmin) {
                visitorActions.classList.toggle('hidden', isAdmin);
                adminArea.classList.toggle('hidden', !isAdmin);
                adminArea.classList.toggle('flex', isAdmin);
                document.querySelectorAll('.admin-controls').forEach(el => { el.style.display = isAdmin ? 'block' : 'none'; });
                prayerTimeAdminControls.classList.toggle('hidden', !isAdmin);
            }
            
            function fetchAllData() {
                unsubs.forEach(unsub => unsub());
                unsubs = [];
                const dataConfig = [
                    { path: 'chanda_data/shared/site_data/prayer_times', type: 'doc', handler: handlePrayerTimes },
                    { path: 'chanda_data/shared/site_data/about_us', type: 'doc', handler: handleAboutUs },
                    { path: 'chanda_data/shared/tabs', type: 'collection', handler: renderTabs },
                    { path: 'chanda_data/shared/events', type: 'collection', container: document.getElementById('events-container-small'), renderer: renderEvent },
                    { path: 'chanda_data/shared/announcements', type: 'collection', container: document.getElementById('announcements-container'), renderer: renderAnnouncement },
                    { path: 'chanda_data/shared/services', type: 'collection', container: document.getElementById('services-container'), renderer: renderService },
                    { path: 'chanda_data/shared/gallery', type: 'collection', container: document.getElementById('gallery-container'), renderer: renderGalleryImage },
                    { path: 'chanda_data/shared/contacts', type: 'collection', container: document.getElementById('contacts-container'), renderer: renderContact }
                ];

                dataConfig.forEach(config => {
                    let unsub;
                    if (config.type === 'doc') unsub = onSnapshot(doc(db, config.path), config.handler);
                    else if (config.handler) unsub = onSnapshot(collection(db, config.path), config.handler);
                    else unsub = onSnapshot(collection(db, config.path), (snapshot) => renderCollection(snapshot, config.container, config.renderer, config.name || config.path.split('/').pop()));
                    unsubs.push(unsub);
                });
            }

            // --- Render Functions ---
            const createAdminControls = (collectionName, docId) => `
                <div class="admin-controls-hover absolute top-1 right-1 hidden gap-1 bg-black/20 p-1 rounded-full">
                    <button class="edit-item-btn bg-blue-500 text-white p-1.5 rounded-full hover:bg-blue-600" data-collection="${collectionName}" data-id="${docId}"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"></path></svg></button>
                    <button class="delete-item-btn bg-red-500 text-white p-1.5 rounded-full hover:bg-red-600" data-collection="${collectionName}" data-id="${docId}"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg></button>
                </div>`;

            function renderCollection(snapshot, container, renderFunction, collectionName) {
                container.innerHTML = '';
                if (snapshot.empty) container.innerHTML = `<p class="text-slate-500 text-center col-span-full">${collectionName} यहाँ जोड़े जाएंगे।</p>`;
                else snapshot.docs.forEach(doc => container.appendChild(renderFunction(doc)));
            }
            
            const renderAnnouncement = doc => { const div = document.createElement('div'); div.className = 'p-4 border-l-4 border-green-600 bg-green-50 rounded-r-lg relative group'; div.innerHTML = `<p class="font-semibold text-green-800">${doc.data().title}</p><p class="text-sm text-slate-600">${doc.data().description}</p>${createAdminControls('announcements', doc.id)}`; return div; };
            const renderService = doc => { const div = document.createElement('div'); div.className = 'bg-white p-6 rounded-xl shadow-md border border-slate-200 text-center relative group'; div.innerHTML = `<h4 class="text-xl font-bold text-green-800">${doc.data().title}</h4><p class="mt-2 text-slate-500">${doc.data().description}</p>${createAdminControls('services', doc.id)}`; return div; };
            const renderGalleryImage = doc => { const div = document.createElement('div'); div.className = 'relative group aspect-video'; div.innerHTML = `<img src="${doc.data().url}" alt="Gallery Image" class="rounded-lg shadow-md w-full h-full object-cover">${createAdminControls('gallery', doc.id)}`; return div; };
            const renderContact = doc => { const div = document.createElement('div'); div.className = 'bg-green-50 p-6 rounded-lg border border-green-200 relative group'; div.innerHTML = `<h4 class="text-xl font-bold text-green-800">${doc.data().name}</h4><p class="font-semibold text-slate-600">${doc.data().title}</p><p class="mt-2 text-lg font-semibold text-gray-800">${doc.data().phone}</p>${createAdminControls('contacts', doc.id)}`; return div; };
            const renderEvent = doc => { const div = document.createElement('div'); div.className = 'relative group flex justify-between items-center'; div.innerHTML = `<span><span class="font-semibold">${doc.data().date}:</span> ${doc.data().title}</span>${createAdminControls('events', doc.id)}`; return div; };
            
            function handlePrayerTimes(docSnap) { const times = docSnap.data() || {}; originalPrayerTimes = times; Object.keys(times).forEach(key => { if(document.getElementById(`${key}-time`)) document.getElementById(`${key}-time`).textContent = times[key] }); }
            function handleAboutUs(docSnap) { const data = docSnap.data() || {}; originalAboutUsText = data.text || "मस्जिद के बारे में जानकारी यहाँ एडमिन द्वारा डाली जाएगी।"; aboutUsTextEl.textContent = originalAboutUsText; }
            function renderTabs(snapshot) {
                infoTabsNav.innerHTML = '';
                infoTabsContent.innerHTML = '';
                snapshot.docs.forEach((doc, index) => {
                    const tabData = doc.data();
                    const btn = document.createElement('button');
                    btn.className = `tab-btn py-2 px-4 text-slate-600 font-semibold transition-colors duration-300 ${index === 0 ? 'active' : ''}`;
                    btn.textContent = tabData.title;
                    btn.dataset.target = `tab-${doc.id}`;
                    infoTabsNav.appendChild(btn);

                    const contentDiv = document.createElement('div');
                    contentDiv.className = `tab-content ${index === 0 ? 'active' : ''}`;
                    contentDiv.id = `tab-${doc.id}`;
                    contentDiv.innerHTML = `<div class="p-4 relative group text-left">${tabData.content.replace(/\n/g, '<br>')}${createAdminControls('tabs', doc.id)}</div>`;
                    infoTabsContent.appendChild(contentDiv);
                });
            }

            // --- Event Listeners ---
            infoTabsNav.addEventListener('click', (e) => {
                const targetBtn = e.target.closest('.tab-btn');
                if (targetBtn) {
                    document.querySelectorAll('#info-tabs-nav .tab-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('#info-tabs-content .tab-content').forEach(c => c.classList.remove('active'));
                    targetBtn.classList.add('active');
                    document.getElementById(targetBtn.dataset.target).classList.add('active');
                }
            });
            
            editPrayerTimesBtn.addEventListener('click', () => { prayerTimeEditButtons.classList.remove('hidden'); editPrayerTimesBtn.classList.add('hidden'); prayerTimeAdminControls.querySelectorAll('.editable-time').forEach(el => el.setAttribute('contenteditable', 'true')); });
            cancelPrayerTimesBtn.addEventListener('click', () => { prayerTimeEditButtons.classList.add('hidden'); editPrayerTimesBtn.classList.remove('hidden'); prayerTimeAdminControls.querySelectorAll('.editable-time').forEach(el => el.setAttribute('contenteditable', 'false')); handlePrayerTimes({ data: () => originalPrayerTimes }); });
            savePrayerTimesBtn.addEventListener('click', async () => { const newTimes = {}; prayerTimeAdminControls.querySelectorAll('.editable-time').forEach(el => { newTimes[el.id.replace('-time', '')] = el.textContent.trim(); }); await setDoc(doc(db, 'chanda_data/shared/site_data/prayer_times'), newTimes, { merge: true }); prayerTimeEditButtons.classList.add('hidden'); editPrayerTimesBtn.classList.remove('hidden'); prayerTimeAdminControls.querySelectorAll('.editable-time').forEach(el => el.setAttribute('contenteditable', 'false')); });
            editAboutUsBtn.addEventListener('click', async () => { if (editAboutUsBtn.textContent === 'एडिट') { aboutUsTextEl.setAttribute('contenteditable', 'true'); aboutUsTextEl.focus(); editAboutUsBtn.textContent = 'सेव करें'; editAboutUsBtn.classList.replace('bg-blue-600', 'bg-green-600'); } else { await setDoc(doc(db, 'chanda_data/shared/site_data/about_us'), { text: aboutUsTextEl.textContent.trim() }, { merge: true }); aboutUsTextEl.setAttribute('contenteditable', 'false'); editAboutUsBtn.textContent = 'एडिट'; editAboutUsBtn.classList.replace('bg-green-600', 'bg-blue-600'); } });

            // --- Qibla Finder ---
            document.getElementById('find-qibla-btn').addEventListener('click', () => { /* ... same as before ... */ });

            // --- Modal & CRUD Logic ---
            const fieldConfigs = {
                announcements: { collection: 'announcements', addTitle: 'नया एलान जोड़ें', editTitle: 'एलान एडिट करें', fields: [{id:'title',label:'टाइटल',type:'text'}, {id:'description',label:'विवरण',type:'text'}] },
                services: { collection: 'services', addTitle: 'नई सेवा जोड़ें', editTitle: 'सेवा एडिट करें', fields: [{id:'title',label:'सेवा का नाम',type:'text'}, {id:'description',label:'सेवा का विवरण',type:'text'}] },
                contacts: { collection: 'contacts', addTitle: 'नया संपर्क जोड़ें', editTitle: 'संपर्क एडिट करें', fields: [{id:'name',label:'नाम',type:'text'}, {id:'title',label:'पद',type:'text'}, {id:'phone',label:'फ़ोन नंबर',type:'tel'}] },
                tabs: { collection: 'tabs', addTitle: 'नया टैब जोड़ें', editTitle: 'टैब एडिट करें', fields: [{id:'title',label:'टैब का नाम',type:'text'}, {id:'content',label:'टैब की जानकारी',type:'textarea'}] },
                events: { collection: 'events', addTitle: 'नया इवेंट जोड़ें', editTitle: 'इवेंट एडिट करें', fields: [{id:'date',label:'तारीख',type:'date'}, {id:'title',label:'इवेंट का नाम',type:'text'}] }
            };
            function openFormModal(config, docData = {}) {
                currentEditContext = { collection: config.collection, id: docData.id, fields: config.fields };
                document.getElementById('form-modal-title').textContent = docData.id ? config.editTitle : config.addTitle;
                const container = document.getElementById('form-fields-container');
                container.innerHTML = '';
                config.fields.forEach(field => {
                    const value = docData[field.id] || '';
                    let fieldHtml;
                    if (field.type === 'textarea') {
                        fieldHtml = `<div><label for="${field.id}" class="block text-sm font-medium text-slate-700 mb-1">${field.label}</label><textarea id="${field.id}" rows="5" class="w-full text-sm border border-slate-300 rounded-lg p-2.5" required>${value}</textarea></div>`;
                    } else {
                        fieldHtml = `<div><label for="${field.id}" class="block text-sm font-medium text-slate-700 mb-1">${field.label}</label><input type="${field.type}" id="${field.id}" value="${value}" class="w-full text-sm border border-slate-300 rounded-lg p-2.5" required></div>`;
                    }
                    container.insertAdjacentHTML('beforeend', fieldHtml);
                });
                formModal.classList.remove('hidden'); formModal.classList.add('flex');
            }
            genericForm.addEventListener('submit', async (e) => { e.preventDefault(); const { collection: coll, id, fields } = currentEditContext; const data = {}; fields.forEach(f => data[f.id] = document.getElementById(f.id).value); const path = `chanda_data/shared/${coll}`; if (id) await updateDoc(doc(db, path, id), data); else await addDoc(collection(db, path), data); formModal.classList.add('hidden'); });
            document.getElementById('cancel-form-btn').addEventListener('click', () => formModal.classList.add('hidden'));

            // --- Add & CRUD Event Listeners ---
            document.getElementById('add-announcement-btn').addEventListener('click', () => openFormModal(fieldConfigs.announcements));
            document.getElementById('add-service-btn').addEventListener('click', () => openFormModal(fieldConfigs.services));
            document.getElementById('add-contact-btn').addEventListener('click', () => openFormModal(fieldConfigs.contacts));
            document.getElementById('add-tab-btn').addEventListener('click', () => openFormModal(fieldConfigs.tabs));
            document.getElementById('add-event-btn').addEventListener('click', () => openFormModal(fieldConfigs.events));
            
            document.getElementById('app').addEventListener('click', async (e) => {
                const editBtn = e.target.closest('.edit-item-btn');
                if (editBtn) { const { collection: coll, id } = editBtn.dataset; const docSnap = await getDoc(doc(db, `chanda_data/shared/${coll}`, id)); openFormModal(fieldConfigs[coll], { id, ...docSnap.data() }); }
                const deleteBtn = e.target.closest('.delete-item-btn');
                if (deleteBtn) { const { collection: coll, id } = deleteBtn.dataset; if (confirm('क्या आप वाकई इसे हटाना चाहते हैं?')) await deleteDoc(doc(db, `chanda_data/shared/${coll}`, id)); }
            });
            
            // --- Image Modal, Auth Modal etc. (same as before, no changes needed) ---
            document.getElementById('add-image-btn').addEventListener('click', () => { imageModal.classList.remove('hidden'); imageModal.classList.add('flex'); imageForm.reset(); });
            document.getElementById('cancel-image-btn').addEventListener('click', () => imageModal.classList.add('hidden'));
            imageForm.addEventListener('submit', async(e) => { e.preventDefault(); const url = document.getElementById('image-url-input').value.trim(); const file = document.getElementById('image-file-input').files[0]; if(url) await saveImageUrlToFirestore(url); else if (file) uploadImage(file); });
            async function saveImageUrlToFirestore(imageUrl) { await addDoc(collection(db, 'chanda_data/shared/gallery'), { url: imageUrl, createdAt: serverTimestamp() }); imageModal.classList.add('hidden'); }
            function uploadImage(file) { /* ... same upload logic ... */ }

            document.getElementById('show-login-modal-btn').addEventListener('click', () => showAuthModal('login'));
            document.getElementById('show-signup-modal-btn').addEventListener('click', () => showAuthModal('signup'));
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            document.getElementById('cancel-auth-btn').addEventListener('click', () => authModal.classList.add('hidden'));
            function showAuthModal(mode) { 
                let currentAuthMode = mode;
                authForm.reset();
                document.getElementById('auth-error').textContent = '';
                document.getElementById('auth-modal-title').textContent = mode === 'login' ? 'एडमिन लॉगिन' : 'नया एडमिन अकाउंट बनाएं';
                document.getElementById('invite-code-field').classList.toggle('hidden', mode === 'login');
                document.getElementById('submit-auth-btn').textContent = mode === 'login' ? 'लॉगिन करें' : 'अकाउंट बनाएं';
                authModal.classList.remove('hidden');
                authModal.classList.add('flex');
            }
            authForm.addEventListener('submit', async (e) => { 
                e.preventDefault();
                const email = document.getElementById('auth-email').value;
                const password = document.getElementById('auth-password').value;
                const authError =  document.getElementById('auth-error');
                try {
                    if (authForm.querySelector('#submit-auth-btn').textContent.includes('अकाउंट')) { // Signup mode
                        const inviteCode = document.getElementById('invite-code').value.trim();
                        if (!inviteCode) throw new Error("Secret Code डालना ज़रूरी है।");
                        const inviteCodeRef = doc(db, 'app_config', 'invite_code');
                        const docSnap = await getDoc(inviteCodeRef);
                        if (docSnap.exists() && inviteCode !== docSnap.data().code) { throw new Error("गलत Secret Code।"); }
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        await setDoc(doc(db, `admins/${userCredential.user.uid}`), { ownerEmail: email });
                        if (!docSnap.exists()) { await setDoc(inviteCodeRef, { code: inviteCode }); }
                    } else { // Login mode
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                    authModal.classList.add('hidden');
                } catch (error) {
                    authError.textContent = error.message;
                }
             });
        }
    </script>

</body>
</html>

